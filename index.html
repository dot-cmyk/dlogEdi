<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive API Example with GIS</title>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <button id="login-btn">Google 로그인</button>
    <button id="check-file-btn" disabled>파일 확인 및 생성</button>

    <script>
        const CLIENT_ID = '474742043344-81ventkmf01jsh475eilq7f79r1io9ma.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDbs-pBcsUBkLS-l3fKWnBG5a09ovCnXCM';
        // const CLIENT_ID = 'YOUR_CLIENT_ID_HERE'; // Google Cloud Console에서 발급받은 클라이언트 ID
        const SCOPES = 'https://www.googleapis.com/auth/drive';
        const FILE_NAME = 'example.json'; // 확인할 파일 이름

        let accessToken = null;

        // Google Identity Services 버튼 초기화
        const button = google.accounts.id.initialize({
            client_id: CLIENT_ID,
            callback: handleCredentialResponse,
            scope: SCOPES  // 스코프 추가
        });

        // 로그인 버튼 표시
        google.accounts.id.renderButton(
            document.getElementById('login-btn'), 
            { theme: 'outline', size: 'large' } // 버튼 스타일
        );

        // 로그인 콜백 처리
        async function handleCredentialResponse(response) {
            try {
                // JWT를 교환하여 액세스 토큰 가져오기
                const result = await fetch('https://oauth2.googleapis.com/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        code: response.credential,
                        client_id: CLIENT_ID,
                        grant_type: 'authorization_code',
                        redirect_uri: 'http://localhost', // 리디렉션 URI
                        scope: SCOPES  // 스코프 추가
                    }),
                });

                const data = await result.json();
                accessToken = data.access_token;

                // gapi 초기화
                await gapi.client.init({
                    apiKey: API_KEY,
                    accessToken: accessToken,
                });

                alert('로그인 성공!');
                document.getElementById('check-file-btn').disabled = false;
            } catch (error) {
                console.error('로그인 처리 중 오류:', error);
            }
        }

        // 파일 검색 및 생성 함수
        async function checkAndCreateFile() {
            try {
            const response = await gapi.client.drive.files.list({
                q: `name='${FILE_NAME}' and trashed=false`,
                fields: 'files(id, name)',
            });
            console.log('API 응답 데이터:', response); // 응답 데이터 확인
    if (response.result && response.result.files && response.result.files.length > 0) {
        alert(`파일이 이미 존재합니다: ${response.result.files[0].name}`);
    } else {
        alert('파일이 없습니다. 새 파일을 생성합니다.');
        await createFile();
    }
} catch (error) {
    console.error('파일 확인 중 오류 발생:', error);
}
        }

        // 새 JSON 파일 생성 함수
        async function createFile() {
            try {
                const metadata = {
                    name: FILE_NAME,
                    mimeType: 'application/json',
                };

                const fileContent = JSON.stringify({}); // 빈 JSON 내용
                const file = new Blob([fileContent], { type: 'application/json' });
                const formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                formData.append('file', file);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                    },
                    body: formData,
                });

                if (response.ok) {
                    const fileData = await response.json();
                    alert(`파일 생성 완료: ${fileData.name}`);
                } else {
                    const errorData = await response.json();
                    console.error('파일 생성 실패:', errorData);
                }
            } catch (error) {
                console.error('파일 생성 중 오류 발생:', error);
            }
        }

        // 버튼 이벤트 연결
        document.getElementById('check-file-btn').addEventListener('click', checkAndCreateFile);

        // gapi 초기화
        gapi.load('client');
    </script>
</body>
</html>
