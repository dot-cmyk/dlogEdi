<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
    <title>Google Drive API Example with GIS</title>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <button id="login-btn">Google 로그인</button>
    <button id="check-file-btn" disabled>파일 확인 및 생성</button>

    <script>
        const CLIENT_ID = '474742043344-81ventkmf01jsh475eilq7f79r1io9ma.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDbs-pBcsUBkLS-l3fKWnBG5a09ovCnXCM';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILE_NAME = 'example.json';

        let accessToken = null;

        // Google Identity Services 초기화
        function initializeGoogleIdentity() {
            google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: handleCredentialResponse,
                scope: SCOPES
            });

            google.accounts.id.renderButton(
                document.getElementById('login-btn'),
                { theme: 'outline', size: 'large' }
            );
        }

        // 인증 응답 처리
        async function handleCredentialResponse(response) {
            try {
                accessToken = response.credential;

                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                });

                gapi.client.setToken({
                    access_token: accessToken
                });

                alert('로그인 성공!');
                document.getElementById('check-file-btn').disabled = false;
            } catch (error) {
                console.error('로그인 처리 중 오류:', error);
            }
        }

        // 파일 검색 및 생성 함수
        async function checkAndCreateFile() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${FILE_NAME}' and trashed=false`,
                    fields: 'files(id, name)'
                });

                if (response.result.files && response.result.files.length > 0) {
                    alert(`파일이 이미 존재합니다: ${response.result.files[0].name}`);
                } else {
                    alert('파일이 없습니다. 새 파일을 생성합니다.');
                    await createFile();
                }
            } catch (error) {
                console.error('파일 확인 중 오류 발생:', error);
            }
        }

        // 새 JSON 파일 생성 함수
        async function createFile() {
            try {
                const metadata = {
                    name: FILE_NAME,
                    mimeType: 'application/json'
                };

                const fileContent = JSON.stringify({});
                const file = new Blob([fileContent], { type: 'application/json' });
                const formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                formData.append('file', file);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        Authorization: `Bearer ${accessToken}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const fileData = await response.json();
                    alert(`파일 생성 완료: ${fileData.name}`);
                } else {
                    const errorData = await response.json();
                    console.error('파일 생성 실패:', errorData);
                }
            } catch (error) {
                console.error('파일 생성 중 오류 발생:', error);
            }
        }

        // 버튼 이벤트 연결
        document.getElementById('check-file-btn').addEventListener('click', checkAndCreateFile);

        // 페이지 로드 시 초기화
        window.onload = function() {
            gapi.load('client', initializeGoogleIdentity);
        };
    </script>
</body>
</html>
